<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>v2.7 Version Check</title>
  <style>
    body {
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 { color: #4ec9b0; }
    .test-section {
      background: #252526;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #3e3e42;
    }
    .pass { color: #4ec9b0; }
    .fail { color: #f48771; }
    .info { color: #ce9178; }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1177bb;
    }
  </style>
</head>
<body>
  <h1>üîç WebDaYi v2.7 Version Check</h1>

  <div class="test-section">
    <h2>Test 1: Check viterbi_module.js Version</h2>
    <div id="test1-result">Loading...</div>
  </div>

  <div class="test-section">
    <h2>Test 2: Check BIGRAM_WEIGHT</h2>
    <div id="test2-result">Loading...</div>
  </div>

  <div class="test-section">
    <h2>Test 3: Run Viterbi Test</h2>
    <button onclick="runViterbiTest()">Run Test</button>
    <div id="test3-result"></div>
  </div>

  <div class="test-section">
    <h2>If tests fail:</h2>
    <button onclick="clearAllCache()">1. Clear All Cache (Hard Refresh)</button>
    <button onclick="location.reload(true)">2. Force Reload</button>
    <button onclick="alert('Please close all browser windows and reopen')">3. Restart Browser</button>
    <p class="info">Or press: <strong>Ctrl + Shift + R</strong> (Windows/Linux) or <strong>Cmd + Shift + R</strong> (Mac)</p>
  </div>

  <!-- Load databases and viterbi with aggressive cache busting -->
  <script>
    const timestamp = Date.now();
    const randomString = Math.random().toString(36).substring(7);

    // Load dayi_db.json
    fetch(`dayi_db.json?t=${timestamp}&r=${randomString}`)
      .then(r => r.json())
      .then(data => {
        window.dayiDbData = data;
        window.dayiDb = new Map(Object.entries(data));
        console.log('‚úì dayiDb loaded');
      });

    // Load ngram_db.json
    fetch(`ngram_db.json?t=${timestamp}&r=${randomString}`)
      .then(r => r.json())
      .then(data => {
        window.ngramDb = data;
        console.log('‚úì ngramDb loaded');
        console.log('  total_chars:', data.total_chars);
        console.log('  vocab_size:', data.vocab_size);
      });
  </script>

  <!-- Load viterbi_module.js with aggressive cache busting -->
  <script>
    const viterbiScript = document.createElement('script');
    viterbiScript.src = `viterbi_module.js?t=${Date.now()}&r=${Math.random().toString(36).substring(7)}`;
    viterbiScript.onload = function() {
      console.log('‚úì viterbi_module.js loaded');
      checkVersion();
    };
    document.head.appendChild(viterbiScript);
  </script>

  <script>
    function checkVersion() {
      // Test 1: Check if viterbi_module.js contains v2.7 marker
      const test1 = document.getElementById('test1-result');

      // Check console log message
      setTimeout(() => {
        const consoleMessages = [];
        const originalLog = console.log;
        console.log = function(...args) {
          consoleMessages.push(args.join(' '));
          originalLog.apply(console, args);
        };

        // Look for v2.7 message in already printed logs
        const hasV27Message = performance.getEntriesByType('resource')
          .some(r => r.name.includes('viterbi_module.js'));

        if (typeof viterbi === 'function') {
          test1.innerHTML = `
            <p class="pass">‚úì viterbi() function exists</p>
            <p class="info">Check browser console for: "‚úì Viterbi module loaded (v2.7 HYBRID - OOP + 70/30 + Laplace)"</p>
          `;
        } else {
          test1.innerHTML = '<p class="fail">‚úó viterbi() function NOT found!</p>';
        }
      }, 500);

      // Test 2: Check BIGRAM_WEIGHT (this is tricky as it's in module scope)
      const test2 = document.getElementById('test2-result');
      test2.innerHTML = `
        <p class="info">BIGRAM_WEIGHT is in module scope, cannot access directly</p>
        <p class="info">Check browser console or run Viterbi test to verify</p>
      `;
    }

    function runViterbiTest() {
      const result = document.getElementById('test3-result');

      if (!window.dayiDb || !window.ngramDb) {
        result.innerHTML = '<p class="fail">‚úó Databases not loaded yet. Please wait and try again.</p>';
        return;
      }

      if (typeof viterbi !== 'function') {
        result.innerHTML = '<p class="fail">‚úó viterbi() function not available!</p>';
        return;
      }

      try {
        const codes = ['dj', 'ev', 'ev', 'c8', 'lo', 'aj', 'ad', '.x', 'ax', 'ob'];
        const viterbiResult = viterbi(codes, window.dayiDb, window.ngramDb);

        const expected_pos6 = 'ÊúÉ';
        const actual_pos6 = viterbiResult.chars[6];

        const isCorrect = actual_pos6 === expected_pos6;
        const className = isCorrect ? 'pass' : 'fail';
        const icon = isCorrect ? '‚úì' : '‚úó';

        result.innerHTML = `
          <h3>Test Case: ÊòéÂ§©Â§©Ê∞£Â¶Ç‰ΩïÊúÉÊîæÂÅáÂóé</h3>
          <p><strong>Result:</strong> ${viterbiResult.sentence}</p>
          <p><strong>Score:</strong> ${viterbiResult.score.toFixed(6)}</p>
          <p class="${className}">${icon} Position 6 (code "ad"): ${actual_pos6} (expected: ${expected_pos6})</p>
          <pre>${viterbiResult.chars.map((c, i) =>
            `${i}. ${codes[i]} ‚Üí ${c} ${i === 6 ? (isCorrect ? '‚úì' : '‚úó WRONG') : ''}`
          ).join('\n')}</pre>
          ${isCorrect ?
            '<p class="pass"><strong>‚úÖ CORRECT! v2.7 is working!</strong></p>' :
            '<p class="fail"><strong>‚ö†Ô∏è WRONG! Browser is using old version!</strong><br>Please clear cache and hard refresh (Ctrl+Shift+R)</p>'
          }
        `;

        console.log('Viterbi test result:', viterbiResult);
      } catch (error) {
        result.innerHTML = `<p class="fail">‚úó Error: ${error.message}</p><pre>${error.stack}</pre>`;
      }
    }

    function clearAllCache() {
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => {
            caches.delete(name);
          });
        });
      }
      alert('Cache cleared! Now press Ctrl+Shift+R to hard refresh.');
    }
  </script>
</body>
</html>
