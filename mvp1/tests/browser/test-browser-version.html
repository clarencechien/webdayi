<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebDaYi - Browser Verification Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #2563eb; }
    h2 { color: #059669; border-bottom: 2px solid #d1fae5; padding-bottom: 8px; }
    .pass { color: #059669; font-weight: bold; }
    .fail { color: #dc2626; font-weight: bold; }
    .info { color: #0284c7; }
    .code { background: #f1f5f9; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
    pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px 10px 0;
    }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .status { padding: 8px 12px; border-radius: 4px; display: inline-block; margin: 5px 0; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.warning { background: #fef3c7; color: #92400e; }
  </style>
</head>
<body>

<h1>üîç WebDaYi Browser Verification Test</h1>

<div class="test-section">
  <h2>Version Information</h2>
  <div id="version-info">Loading...</div>
</div>

<div class="test-section">
  <h2>Module Loading Status</h2>
  <div id="module-status">Checking...</div>
</div>

<div class="test-section">
  <h2>Database Loading</h2>
  <button id="load-db-btn">1. Load Dayi DB</button>
  <button id="load-ngram-btn" disabled>2. Load N-gram DB</button>
  <div id="db-status" style="margin-top: 10px;"></div>
</div>

<div class="test-section">
  <h2>Test Case 1: Â§ßÂÆ∂Â•ΩÊàëÊòØÂ§ßÂ≠∏Áîü</h2>
  <button id="test1-btn" disabled>Run Test 1</button>
  <div id="test1-result" style="margin-top: 10px;"></div>
</div>

<div class="test-section">
  <h2>Test Case 2: ÊòéÂ§©Â§©Ê∞£Â¶Ç‰ΩïÊúÉÊîæÂÅáÂóé</h2>
  <button id="test2-btn" disabled>Run Test 2</button>
  <div id="test2-result" style="margin-top: 10px;"></div>
</div>

<div class="test-section">
  <h2>Cache Verification</h2>
  <p>This page was loaded at: <span class="code" id="load-time"></span></p>
  <p>To ensure you're running the latest version:</p>
  <ol>
    <li>Press <strong>Ctrl+Shift+R</strong> (Windows/Linux) or <strong>Cmd+Shift+R</strong> (Mac)</li>
    <li>Open DevTools (F12) ‚Üí Network tab ‚Üí Check "Disable cache"</li>
    <li>Reload this page</li>
  </ol>
</div>

<!-- Load all modules in correct order -->
<script src="viterbi_module.js"></script>

<script>
// Global state
let dayiMap = null;
let ngramDb = null;

// Display load time
document.getElementById('load-time').textContent = new Date().toLocaleString();

// 1. Check version information
function checkVersion() {
  const versionDiv = document.getElementById('version-info');

  // Check if viterbi functions exist
  const hasviterbi = typeof viterbi === 'function';
  const hasLaplace = typeof getLaplaceUnigram === 'function' && typeof getLaplaceBigram === 'function';

  let html = '<pre>';
  html += `Viterbi module: ${hasviterbi ? '‚úì Loaded' : '‚úó NOT FOUND'}\n`;
  html += `Laplace smoothing: ${hasLaplace ? '‚úì Available (v2.0)' : '‚úó NOT AVAILABLE (old version)'}\n`;
  html += '</pre>';

  if (!hasviterbi || !hasLaplace) {
    html += '<div class="status error">‚ö†Ô∏è OLD VERSION DETECTED - Please hard refresh (Ctrl+Shift+R)</div>';
  } else {
    html += '<div class="status success">‚úì Latest version loaded correctly</div>';
  }

  versionDiv.innerHTML = html;

  return hasviterbi && hasLaplace;
}

// 2. Check module loading
function checkModules() {
  const statusDiv = document.getElementById('module-status');

  const checks = [
    { name: 'viterbi', fn: () => typeof viterbi === 'function' },
    { name: 'getLaplaceUnigram', fn: () => typeof getLaplaceUnigram === 'function' },
    { name: 'getLaplaceBigram', fn: () => typeof getLaplaceBigram === 'function' },
    { name: 'buildLattice', fn: () => typeof buildLattice === 'function' },
  ];

  let html = '<pre>';
  let allPass = true;

  checks.forEach(check => {
    const pass = check.fn();
    html += `${pass ? '‚úì' : '‚úó'} ${check.name}\n`;
    if (!pass) allPass = false;
  });

  html += '</pre>';

  if (!allPass) {
    html += '<div class="status error">‚ö†Ô∏è Some modules failed to load - Hard refresh required!</div>';
  } else {
    html += '<div class="status success">‚úì All modules loaded successfully</div>';
  }

  statusDiv.innerHTML = html;
}

// 3. Load Dayi DB
document.getElementById('load-db-btn').onclick = async function() {
  const statusDiv = document.getElementById('db-status');
  statusDiv.innerHTML = '<div class="status warning">Loading Dayi DB...</div>';

  try {
    const response = await fetch('dayi_db.json');
    const dayiDbRaw = await response.json();
    dayiMap = new Map(Object.entries(dayiDbRaw));

    statusDiv.innerHTML = `<div class="status success">‚úì Dayi DB loaded: ${dayiMap.size} codes</div>`;
    document.getElementById('load-ngram-btn').disabled = false;
  } catch (error) {
    statusDiv.innerHTML = `<div class="status error">‚úó Failed to load Dayi DB: ${error.message}</div>`;
  }
};

// 4. Load N-gram DB
document.getElementById('load-ngram-btn').onclick = async function() {
  const statusDiv = document.getElementById('db-status');
  statusDiv.innerHTML += '<div class="status warning">Loading N-gram DB (10MB)...</div>';

  try {
    const response = await fetch('ngram_db.json');
    ngramDb = await response.json();

    const stats = `
      Version: ${ngramDb.version || 'unknown'}
      Unigrams: ${Object.keys(ngramDb.unigrams).length}
      Bigrams: ${Object.keys(ngramDb.bigrams).length}
      Smoothing Alpha: ${ngramDb.smoothing_alpha}
      Total Chars: ${ngramDb.total_chars}
      Vocab Size: ${ngramDb.vocab_size}
    `;

    statusDiv.innerHTML += `<div class="status success">‚úì N-gram DB loaded</div><pre>${stats}</pre>`;
    document.getElementById('test1-btn').disabled = false;
    document.getElementById('test2-btn').disabled = false;
  } catch (error) {
    statusDiv.innerHTML += `<div class="status error">‚úó Failed to load N-gram DB: ${error.message}</div>`;
  }
};

// 5. Test Case 1
document.getElementById('test1-btn').onclick = function() {
  const resultDiv = document.getElementById('test1-result');
  const codes = ['v', 'm,', 'lg', 'v5', 'd9', 'v', 'wg', '2e'];
  const expected = 'Â§ßÂÆ∂Â•ΩÊàëÊòØÂ§ßÂ≠∏Áîü';

  try {
    const result = viterbi(codes, dayiMap, ngramDb);
    const isPass = result.sentence === expected;

    let html = `
      <div class="status ${isPass ? 'success' : 'error'}">
        ${isPass ? '‚úì PASS' : '‚úó FAIL'}
      </div>
      <pre>
Expected: ${expected}
Got:      ${result.sentence}
Score:    ${result.score.toFixed(3)}
Match:    ${isPass ? 'YES' : 'NO'}

Character breakdown:
`;

    result.chars.forEach((char, i) => {
      const expectedChar = expected[i];
      const match = char === expectedChar;
      html += `  ${match ? '‚úì' : '‚úó'} ${char} (${codes[i]}) ${match ? '' : '!= ' + expectedChar}\n`;
    });

    html += '</pre>';
    resultDiv.innerHTML = html;
  } catch (error) {
    resultDiv.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
  }
};

// 6. Test Case 2
document.getElementById('test2-btn').onclick = function() {
  const resultDiv = document.getElementById('test2-result');
  const codes = ['dj', 'ev', 'ev', 'c8', 'lo', 'aj', 'ad', '.x', 'ax', 'ob'];
  const expected = 'ÊòéÂ§©Â§©Ê∞£Â¶Ç‰ΩïÊúÉÊîæÂÅáÂóé';

  try {
    const result = viterbi(codes, dayiMap, ngramDb);
    const isPass = result.sentence === expected;

    let html = `
      <div class="status ${isPass ? 'success' : 'error'}">
        ${isPass ? '‚úì PASS' : '‚úó FAIL'}
      </div>
      <pre>
Expected: ${expected}
Got:      ${result.sentence}
Score:    ${result.score.toFixed(3)}
Match:    ${isPass ? 'YES' : 'NO'}

Character breakdown:
`;

    result.chars.forEach((char, i) => {
      const expectedChar = expected[i];
      const match = char === expectedChar;
      html += `  ${match ? '‚úì' : '‚úó'} ${char} (${codes[i]}) ${match ? '' : '!= ' + expectedChar}\n`;
    });

    html += '</pre>';

    // Show bigram analysis for first mismatch
    let firstMismatch = -1;
    for (let i = 0; i < result.chars.length; i++) {
      if (result.chars[i] !== expected[i]) {
        firstMismatch = i;
        break;
      }
    }

    if (firstMismatch >= 0) {
      const wrongChar = result.chars[firstMismatch];
      const correctChar = expected[firstMismatch];
      const prevChar = firstMismatch > 0 ? result.chars[firstMismatch - 1] : null;

      if (prevChar) {
        const wrongBigram = prevChar + wrongChar;
        const correctBigram = prevChar + correctChar;

        const wrongCount = ngramDb.bigram_counts[wrongBigram] || 0;
        const correctCount = ngramDb.bigram_counts[correctBigram] || 0;

        const wrongProb = getLaplaceBigram(prevChar, wrongChar, ngramDb);
        const correctProb = getLaplaceBigram(prevChar, correctChar, ngramDb);

        html += `\n\nFirst mismatch at position ${firstMismatch}:
  Wrong: ${wrongChar} (${wrongBigram}: count=${wrongCount}, prob=${wrongProb.toExponential(6)})
  Correct: ${correctChar} (${correctBigram}: count=${correctCount}, prob=${correctProb.toExponential(6)})
  Winner should be: ${correctProb > wrongProb ? correctChar : wrongChar}`;
      }
    }

    html += '</pre>';
    resultDiv.innerHTML = html;
  } catch (error) {
    resultDiv.innerHTML = `<div class="status error">‚úó Error: ${error.message}</div>`;
  }
};

// Run initial checks
checkVersion();
checkModules();

console.log('%c=== WebDaYi Browser Verification Test ===', 'font-size: 16px; font-weight: bold; color: #2563eb;');
console.log('This page verifies that the correct version is loaded in the browser.');
console.log('If tests fail, try hard refresh: Ctrl+Shift+R (Windows/Linux) or Cmd+Shift+R (Mac)');
</script>

</body>
</html>
