<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Browser Diagnosis Test - Space/= Keys</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1e293b; color: #e2e8f0; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #475569; border-radius: 8px; background: #0f172a; }
    .pass { color: #10b981; }
    .fail { color: #ef4444; }
    .warn { color: #f59e0b; }
    input, button { padding: 10px; margin: 5px; font-size: 16px; }
    pre { background: #1e293b; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ” Browser Diagnosis Test</h1>
  <p>æ¸¬è©¦ Space å’Œ = éµçš„å¯¦éš›è¡Œç‚º</p>

  <div class="section">
    <h3>Test Input</h3>
    <input id="test-input" type="text" placeholder="åœ¨é€™è£¡è¼¸å…¥ v ç„¶å¾ŒæŒ‰ Space" autofocus />
    <div>
      <button id="switch-sentence">åˆ‡æ›åˆ°æ•´å¥æ¨¡å¼</button>
      <button id="test-predict">æ¸¬è©¦é æ¸¬æŒ‰éˆ•</button>
    </div>
    <p>ç•¶å‰æ¨¡å¼: <span id="current-mode" class="warn">unknown</span></p>
  </div>

  <div class="section">
    <h3>Diagnosis Results</h3>
    <pre id="results"></pre>
  </div>

  <script src="core_logic.js"></script>
  <script src="core_logic_v11.js"></script>
  <script src="core_logic_v11_ui.js"></script>

  <script>
    const results = document.getElementById('results');
    const testInput = document.getElementById('test-input');
    const switchBtn = document.getElementById('switch-sentence');
    const testPredictBtn = document.getElementById('test-predict');
    const modeDisplay = document.getElementById('current-mode');

    let logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toISOString().substr(11, 8);
      const prefix = type === 'pass' ? 'âœ“' : type === 'fail' ? 'âœ—' : type === 'warn' ? 'âš ' : 'â„¹';
      logs.push(`[${timestamp}] ${prefix} ${message}`);
      results.textContent = logs.join('\n');
      results.scrollTop = results.scrollHeight;
    }

    // Test 1: Check if functions are defined
    log('=== Test 1: Check Function Definitions ===');

    if (typeof isSentenceMode === 'function') {
      log('isSentenceMode() defined', 'pass');
    } else {
      log('isSentenceMode() NOT defined', 'fail');
    }

    if (typeof setInputMode === 'function') {
      log('setInputMode() defined', 'pass');
    } else {
      log('setInputMode() NOT defined', 'fail');
    }

    if (typeof window.triggerSentencePrediction === 'function') {
      log('window.triggerSentencePrediction defined', 'pass');
    } else {
      log('window.triggerSentencePrediction NOT defined', 'fail');
    }

    if (typeof window.confirmPrediction === 'function') {
      log('window.confirmPrediction defined', 'pass');
    } else {
      log('window.confirmPrediction NOT defined', 'fail');
    }

    if (typeof addToCodeBuffer === 'function') {
      log('addToCodeBuffer() defined', 'pass');
    } else {
      log('addToCodeBuffer() NOT defined', 'fail');
    }

    // Test 2: Switch to sentence mode
    log('');
    log('=== Test 2: Switch to Sentence Mode ===');

    switchBtn.addEventListener('click', () => {
      if (typeof setInputMode === 'function') {
        setInputMode('sentence');
        const mode = isSentenceMode();
        modeDisplay.textContent = mode ? 'æ•´å¥æ¨¡å¼' : 'é€å­—æ¨¡å¼';
        modeDisplay.className = mode ? 'pass' : 'fail';
        log(`Switched to sentence mode: ${mode}`, mode ? 'pass' : 'fail');
      } else {
        log('setInputMode() not available!', 'fail');
      }
    });

    // Test 3: Monitor keydown events
    log('');
    log('=== Test 3: Keydown Event Monitoring ===');

    testInput.addEventListener('keydown', (e) => {
      const key = e.key;
      const isInSentenceMode = typeof isSentenceMode === 'function' && isSentenceMode();

      if (key === ' ') {
        log(`Space key pressed! Sentence mode: ${isInSentenceMode}`, 'warn');
        log(`  - Input value: "${testInput.value}"`, 'info');
        log(`  - Default prevented: checking...`, 'info');

        // This is a test, don't interfere with actual handling
        setTimeout(() => {
          log(`  - Input value after: "${testInput.value}"`, 'info');
          if (testInput.value.includes(' ')) {
            log(`  - Space NOT prevented! (has space in value)`, 'fail');
          } else {
            log(`  - Space WAS prevented! (no space in value)`, 'pass');
          }
        }, 10);
      }

      if (key === '=') {
        log(`= key pressed! Sentence mode: ${isInSentenceMode}`, 'warn');
        log(`  - Input value: "${testInput.value}"`, 'info');

        setTimeout(() => {
          log(`  - Input value after: "${testInput.value}"`, 'info');
          if (testInput.value.includes('=')) {
            log(`  - = NOT prevented! (has = in value)`, 'fail');
          } else {
            log(`  - = WAS prevented! (no = in value)`, 'pass');
          }
        }, 10);
      }
    }, true); // Use capture phase to catch before other handlers

    // Test 4: Monitor input events
    testInput.addEventListener('input', (e) => {
      const value = e.target.value;
      log(`Input event: value = "${value}"`, 'info');

      if (value.includes(' ')) {
        log(`  - WARNING: Space character in input!`, 'fail');
      }
      if (value.includes('=')) {
        log(`  - WARNING: = character in input!`, 'fail');
      }
    });

    // Test 5: Test prediction button
    testPredictBtn.addEventListener('click', () => {
      log('');
      log('=== Test 5: Prediction Button Clicked ===');

      if (typeof window.confirmPrediction === 'function') {
        log('Calling window.confirmPrediction()...', 'info');
        try {
          window.confirmPrediction();
          log('window.confirmPrediction() executed', 'pass');
        } catch (err) {
          log(`window.confirmPrediction() error: ${err.message}`, 'fail');
        }
      } else {
        log('window.confirmPrediction NOT defined!', 'fail');
      }
    });

    log('');
    log('=== Ready for Testing ===');
    log('1. Click "åˆ‡æ›åˆ°æ•´å¥æ¨¡å¼" button');
    log('2. Type "v" in input box');
    log('3. Press Space key');
    log('4. Check if Space was prevented');
    log('5. Try pressing = key');
    log('6. Check results above');
  </script>
</body>
</html>
