<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>v2.3 Verification Test - CACHE BUSTER</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .pass { color: #00ff00; }
    .fail { color: #ff0000; }
    .info { color: #ffff00; }
    pre {
      background: #000;
      padding: 10px;
      border: 1px solid #333;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>üî¨ v2.3 Frequency Bonus Verification Test</h1>
  <p class="info">‚ö†Ô∏è This page has a unique timestamp to bypass browser cache!</p>
  <p class="info">Timestamp: <?php echo time(); ?><!-- CACHE BUSTER: <?= Date.now() ?> --></p>

  <div id="output"></div>

  <script src="dayi_db.json" type="application/json"></script>
  <script src="ngram_db.json" type="application/json"></script>

  <!-- CRITICAL: Add timestamp to bypass cache! -->
  <script src="viterbi_module.js?v=<?= Date.now() ?>"></script>

  <script>
    const output = document.getElementById('output');

    function log(msg, className = 'info') {
      const div = document.createElement('div');
      div.className = className;
      div.textContent = msg;
      output.appendChild(div);
    }

    function logPre(msg) {
      const pre = document.createElement('pre');
      pre.textContent = msg;
      output.appendChild(pre);
    }

    log('='.repeat(80));
    log('üîç STEP 1: Check if v2.3 functions are loaded', 'info');
    log('='.repeat(80));

    // Check if functions exist
    const functions = ['buildLattice', 'initializeDP', 'forwardPass', 'backtrack', 'viterbi'];
    functions.forEach(fn => {
      if (typeof window[fn] === 'function') {
        log(`‚úì ${fn} exists`, 'pass');
      } else {
        log(`‚úó ${fn} missing!`, 'fail');
      }
    });

    log('');
    log('='.repeat(80));
    log('üîç STEP 2: Check if frequency bonus is applied in code', 'info');
    log('='.repeat(80));

    // Read the actual source code of forwardPass
    const forwardPassCode = window.forwardPass.toString();

    if (forwardPassCode.includes('freqBonus')) {
      log('‚úì forwardPass contains "freqBonus" variable', 'pass');
    } else {
      log('‚úó forwardPass does NOT contain "freqBonus"!', 'fail');
      log('‚ö†Ô∏è This means you are running OLD CODE (v2.0-v2.2)', 'fail');
    }

    if (forwardPassCode.includes('candidate.freq * 1e-9')) {
      log('‚úì forwardPass contains frequency bonus calculation', 'pass');
    } else {
      log('‚úó forwardPass does NOT contain frequency bonus calculation!', 'fail');
    }

    if (forwardPassCode.includes('maxProb + freqBonus')) {
      log('‚úì forwardPass adds freqBonus to DP score', 'pass');
    } else {
      log('‚úó forwardPass does NOT add freqBonus!', 'fail');
    }

    log('');
    log('üîç Code snippet from forwardPass:');
    const relevantCode = forwardPassCode.slice(
      Math.max(0, forwardPassCode.indexOf('freqBonus') - 200),
      forwardPassCode.indexOf('freqBonus') + 200
    );
    logPre(relevantCode || 'freqBonus not found in code!');

    log('');
    log('='.repeat(80));
    log('üîç STEP 3: Run actual test with instrumentation', 'info');
    log('='.repeat(80));

    // Wait for databases to load
    setTimeout(async () => {
      try {
        // Fetch databases
        const dayiDbResponse = await fetch('dayi_db.json');
        const dayiDbData = await dayiDbResponse.json();
        const dayiDb = new Map(Object.entries(dayiDbData));

        const ngramDbResponse = await fetch('ngram_db.json');
        const ngramDb = await ngramDbResponse.json();

        log('‚úì Databases loaded', 'pass');

        // Test codes
        const codes = ['dj', 'ev', 'ev', 'c8', 'lo', 'aj', 'ad', '.x', 'ax', 'ob'];
        log(`Test input: ${codes.join(' ')}`);

        // Build lattice manually to inspect
        const lattice = buildLattice(codes, dayiDb);

        log('');
        log('Position 4 (code "lo") candidates:');
        lattice[4].slice(0, 5).forEach((c, i) => {
          log(`  ${i+1}. ${c.char} (freq=${c.freq})`);
        });

        log('');
        log('Position 5 (code "aj") candidates:');
        lattice[5].slice(0, 5).forEach((c, i) => {
          log(`  ${i+1}. ${c.char} (freq=${c.freq})`);
        });

        // Run Viterbi
        log('');
        log('Running Viterbi algorithm...');
        const result = viterbi(codes, dayiDb, ngramDb);

        log('');
        log('='.repeat(80));
        log('üìä RESULTS:', 'info');
        log('='.repeat(80));
        log(`Sentence: ${result.sentence}`);
        log(`Score: ${result.score.toFixed(6)}`);

        // Check each character
        log('');
        log('Character-by-character analysis:');
        result.chars.forEach((char, i) => {
          const candidates = lattice[i];
          const candidateInfo = candidates.find(c => c.char === char);
          const rank = candidates.findIndex(c => c.char === char) + 1;

          const style = candidateInfo.freq > 5000 ? 'pass' : 'fail';
          log(`  ${i}. ${codes[i]} ‚Üí ${char} (freq=${candidateInfo.freq}, rank=${rank}/${candidates.length})`, style);
        });

        log('');
        log('='.repeat(80));
        log('üéØ VERDICT:', 'info');
        log('='.repeat(80));

        const expectedChars = ['Êòé', 'Â§©', 'Â§©', 'Ê∞£', 'Â¶Ç', '‰Ωï', 'ÊúÉ', 'Êîæ', 'ÂÅá', 'Âóé'];
        const matches = result.chars.every((char, i) => char === expectedChars[i]);

        if (matches) {
          log('‚úì‚úì‚úì TEST PASSED! v2.3 is working correctly!', 'pass');
        } else {
          log('‚úó‚úó‚úó TEST FAILED! Still selecting wrong characters!', 'fail');
          log('');
          log('Expected: ' + expectedChars.join(''), 'info');
          log('Got:      ' + result.chars.join(''), 'info');

          // Check if score changed
          const oldScore = -76.157;
          if (Math.abs(result.score - oldScore) < 0.001) {
            log('');
            log('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRITICAL: Score is identical to v2.2!', 'fail');
            log('‚ö†Ô∏è This strongly suggests BROWSER CACHE issue!', 'fail');
            log('‚ö†Ô∏è Try:', 'fail');
            log('   1. Clear ALL browser cache (not just hard refresh)', 'fail');
            log('   2. Open in Incognito/Private window', 'fail');
            log('   3. Use different browser', 'fail');
            log('   4. Check Network tab in DevTools - viterbi_module.js should be 200, not 304', 'fail');
          }
        }

      } catch (error) {
        log('‚úó Error: ' + error.message, 'fail');
        logPre(error.stack);
      }
    }, 100);
  </script>
</body>
</html>
