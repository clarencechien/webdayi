<!DOCTYPE html>
<html class="dark" lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebDaYi PWA (ç¶²é å¤§æ˜“è¼¸å…¥æ³•) - Phase 0.5 POC</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="Progressive Web App for Dayi Chinese Input Method with personalized N-gram learning">
  <meta name="theme-color" content="#4ec9b0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="WebDaYi PWA">

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">

  <!-- PWA Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180x180.png">

  <!-- Version Information (for testing verification) -->
  <meta name="app-version" content="0.5.0">
  <meta name="app-build" content="20251113-001">
  <meta name="app-commit" content="pwa-poc">
  <meta name="app-release" content="PWA POC with IndexedDB + Mobile Keyboard">
  <!--
    WebDaYi PWA POC - Version 0.5.0
    Build: 20251113-001
    Release: PWA POC with IndexedDB + Mobile Keyboard
    Phase: 0.5 (PWA Proof of Concept)

    Latest Changes:
    - Progressive Web App with Service Worker
    - IndexedDB for user N-gram learning (offline-first)
    - Manual Export/Import for cross-device sync
    - Mobile Custom Touch Keyboard (RWD approach)
    - Based on v2.7 hybrid N-gram engine
    - Installable on mobile and desktop

    Features:
    - Service Worker: Offline support + caching
    - IndexedDB: Local user_ngram.db storage
    - Export/Import: JSON file sync across devices
    - Mobile Keyboard: Custom Dayi layout (not QWERTY)
    - Unified Logic: Same N-gram engine for desktop + mobile

    How to verify version:
    1. Open browser DevTools console
    2. Check: "PWA Service Worker registered"
    3. Check: "IndexedDB module loaded"
    4. Mobile: Custom keyboard appears at bottom
  -->

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style type="text/tailwindcss">
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
    }
  </style>

  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#0fb8f0",
            "background-light": "#f5f8f8",
            "background-dark": "#101e22",
          },
          fontFamily: {
            "display": ["Space Grotesk", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-800 dark:text-slate-200 transition-colors duration-200">

  <!-- Fixed Control Buttons (Desktop) -->
  <div id="desktop-controls" class="fixed top-4 right-4 z-50 hidden sm:flex flex-col gap-2">
    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle"
            class="flex h-10 items-center gap-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-md transition-all hover:shadow-lg"
            aria-label="åˆ‡æ›æ·±è‰²æ¨¡å¼">
      <span class="material-symbols-outlined text-base">dark_mode</span>
      <span>Dark</span>
    </button>

    <!-- Express Mode Toggle -->
    <button id="mode-toggle-btn"
            class="flex h-10 items-center gap-2 rounded-lg bg-primary/10 dark:bg-primary/20 border border-primary px-4 text-sm font-medium text-primary hover:bg-primary/20 dark:hover:bg-primary/30 shadow-md transition-all hover:shadow-lg"
            aria-label="åˆ‡æ›å°ˆæ³¨æ¨¡å¼">
      <span class="material-symbols-outlined text-base">center_focus_strong</span>
      <span>Focus</span>
    </button>

    <!-- Auto-Copy Toggle -->
    <button id="auto-copy-toggle-btn"
            class="flex h-10 items-center gap-2 rounded-lg bg-white dark:bg-slate-800 border-2 px-4 text-sm font-medium shadow-md transition-all hover:shadow-lg"
            aria-label="è‡ªå‹•è¤‡è£½">
      <span class="material-symbols-outlined text-base">content_copy</span>
      <span class="auto-copy-label">Auto</span>
    </button>

    <!-- v11: Input Mode Toggle (Character/Sentence) -->
    <button id="char-mode-btn"
            class="flex h-10 items-center gap-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-md transition-all hover:shadow-lg v11-mode-btn"
            aria-label="åˆ‡æ›é€å­—æ¨¡å¼">
      <span class="material-symbols-outlined text-base">text_fields</span>
      <span>é€å­—</span>
    </button>

    <button id="sentence-mode-btn"
            class="flex h-10 items-center gap-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-md transition-all hover:shadow-lg v11-mode-btn"
            aria-label="åˆ‡æ›æ•´å¥æ¨¡å¼">
      <span class="material-symbols-outlined text-base">auto_awesome</span>
      <span>æ•´å¥</span>
    </button>


    <!-- Font Size Decrease -->
    <button id="font-size-decrease-btn"
            class="flex h-10 items-center gap-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-md transition-all hover:shadow-lg"
            aria-label="ç¸®å°å­—é«”">
      <span class="text-base">Aâˆ’</span>
    </button>

    <!-- Font Size Increase -->
    <button id="font-size-increase-btn"
            class="flex h-10 items-center gap-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 shadow-md transition-all hover:shadow-lg"
            aria-label="æ”¾å¤§å­—é«”">
      <span class="text-base">A+</span>
    </button>
  </div>

  <!-- Mobile FAB Button -->
  <button id="mobile-controls-fab"
          class="fixed top-4 right-4 z-50 flex sm:hidden h-12 w-12 items-center justify-center rounded-full bg-primary text-white shadow-lg hover:shadow-xl transition-all hover:scale-105"
          aria-label="é–‹å•Ÿè¨­å®š">
    <span class="material-symbols-outlined text-xl">settings</span>
  </button>

  <!-- Mobile Control Panel -->
  <div id="mobile-controls-panel"
       class="fixed inset-0 z-50 hidden sm:hidden">
    <!-- Backdrop -->
    <div class="backdrop absolute inset-0 bg-black/50 backdrop-blur-sm"
         onclick="document.getElementById('mobile-controls-panel').classList.add('hidden')"></div>

    <!-- Panel -->
    <div class="panel absolute top-0 right-0 bottom-0 w-72 bg-white dark:bg-slate-900 shadow-2xl transform transition-transform">
      <div class="flex flex-col h-full p-6">
        <!-- Panel Header -->
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white">è¨­å®š (Settings)</h3>
          <button onclick="document.getElementById('mobile-controls-panel').classList.add('hidden')"
                  class="flex h-8 w-8 items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                  aria-label="é—œé–‰">
            <span class="material-symbols-outlined text-xl">close</span>
          </button>
        </div>

        <!-- Control Buttons -->
        <div class="space-y-3">
          <!-- Dark Mode Toggle (Mobile) -->
          <button id="dark-mode-toggle-mobile"
                  class="flex w-full h-12 items-center gap-3 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                  aria-label="åˆ‡æ›æ·±è‰²æ¨¡å¼">
            <span class="material-symbols-outlined text-xl">dark_mode</span>
            <span>æ·±è‰²æ¨¡å¼ (Dark Mode)</span>
          </button>

          <!-- Focus Mode Toggle (Mobile) -->
          <button id="mode-toggle-btn-mobile"
                  class="flex w-full h-12 items-center gap-3 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                  aria-label="åˆ‡æ›å°ˆæ³¨æ¨¡å¼">
            <span class="material-symbols-outlined text-xl">center_focus_strong</span>
            <span id="mode-label-mobile">å°ˆæ³¨æ¨¡å¼ (Focus Mode)</span>
          </button>

          <!-- Auto-Copy Toggle (Mobile) -->
          <button id="auto-copy-toggle-btn-mobile"
                  class="flex w-full h-12 items-center gap-3 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                  aria-label="è‡ªå‹•è¤‡è£½">
            <span class="material-symbols-outlined text-xl">content_copy</span>
            <span class="auto-copy-label-mobile">è‡ªå‹•è¤‡è£½ (Auto-Copy)</span>
          </button>

          <!-- v11: Input Mode Toggle (Mobile) -->
          <div class="flex gap-2">
            <button id="char-mode-btn-mobile"
                    class="flex flex-1 h-12 items-center justify-center gap-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all v11-mode-btn-mobile"
                    aria-label="åˆ‡æ›é€å­—æ¨¡å¼">
              <span class="material-symbols-outlined text-lg">text_fields</span>
              <span class="text-xs">é€å­—</span>
            </button>
            <button id="sentence-mode-btn-mobile"
                    class="flex flex-1 h-12 items-center justify-center gap-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all v11-mode-btn-mobile"
                    aria-label="åˆ‡æ›æ•´å¥æ¨¡å¼">
              <span class="material-symbols-outlined text-lg">auto_awesome</span>
              <span class="text-xs">æ•´å¥</span>
            </button>
          </div>

          <!-- Font Size Controls (Mobile) -->
          <div class="flex gap-2">
            <button id="font-size-decrease-btn-mobile"
                    class="flex flex-1 h-12 items-center justify-center gap-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                    aria-label="ç¸®å°å­—é«”">
              <span class="text-lg">Aâˆ’</span>
              <span class="text-xs">ç¸®å°</span>
            </button>
            <button id="font-size-increase-btn-mobile"
                    class="flex flex-1 h-12 items-center justify-center gap-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all"
                    aria-label="æ”¾å¤§å­—é«”">
              <span class="text-lg">A+</span>
              <span class="text-xs">æ”¾å¤§</span>
            </button>
          </div>

          <!-- Divider -->
          <div class="w-full h-px bg-slate-300 dark:bg-slate-600 my-3"></div>

          <!-- PWA: UserDB Status (Mobile) -->
          <div class="px-3 py-2 text-xs text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700">
            <div id="userdb-status-mobile" class="text-center">
              â³ IndexedDB Loading...
            </div>
          </div>

          <!-- PWA: Learning Data Management (Mobile) -->
          <div class="space-y-2 mt-3">
            <!-- Export Button -->
            <button onclick="exportLearnedPatterns()"
                    class="flex w-full h-11 items-center gap-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 px-4 text-sm font-medium text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-900/30 transition-all"
                    aria-label="åŒ¯å‡ºå­¸ç¿’è³‡æ–™">
              <span class="material-symbols-outlined text-lg">download</span>
              <span>åŒ¯å‡ºå­¸ç¿’è¨˜éŒ„ (Export)</span>
            </button>

            <!-- Import Button -->
            <button onclick="importLearnedPatterns()"
                    class="flex w-full h-11 items-center gap-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 px-4 text-sm font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-all"
                    aria-label="åŒ¯å…¥å­¸ç¿’è³‡æ–™">
              <span class="material-symbols-outlined text-lg">upload</span>
              <span>åŒ¯å…¥å­¸ç¿’è¨˜éŒ„ (Import)</span>
            </button>

            <!-- Clear All Button -->
            <button onclick="clearAllPatterns()"
                    class="flex w-full h-11 items-center gap-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 px-4 text-sm font-medium text-red-700 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-900/30 transition-all"
                    aria-label="æ¸…é™¤æ‰€æœ‰å­¸ç¿’è³‡æ–™">
              <span class="material-symbols-outlined text-lg">delete_sweep</span>
              <span>æ¸…é™¤å­¸ç¿’è¨˜éŒ„ (Clear)</span>
            </button>
          </div>
        </div>

        <!-- Panel Footer -->
        <div class="mt-auto pt-6 border-t border-slate-200 dark:border-slate-800">
          <p class="text-xs text-slate-500 dark:text-slate-400 text-center">
            å­—é«”å¤§å°: <span id="font-scale-display-mobile">100%</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Copy Toast Notification -->
  <div id="copy-toast"
       class="fixed bottom-6 right-6 z-50 hidden rounded-lg bg-green-500 px-6 py-3 text-white font-medium shadow-lg animate-slide-in">
    <div class="flex items-center gap-2">
      <span class="material-symbols-outlined text-base">check_circle</span>
      <span>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</span>
    </div>
  </div>

  <!-- Language Mode Indicator (Issue 3 - English mixed input) -->
  <div id="language-mode-indicator"
       class="fixed bottom-6 right-6 z-50 hidden rounded-lg bg-yellow-500 px-6 py-3 text-white font-semibold shadow-lg">
    <div class="flex items-center gap-2">
      <span class="material-symbols-outlined text-base">language</span>
      <span>English Mode (æŒ‰ Shift è¿”å›ä¸­æ–‡)</span>
    </div>
  </div>

  <!-- Main Container -->
  <div class="flex min-h-screen w-full flex-col items-center p-4 sm:p-6 md:p-8">
    <div class="w-full max-w-3xl space-y-8">

      <!-- Header -->
      <header class="flex flex-col items-center gap-2 text-center" id="app-header">
        <div class="flex items-center gap-3">
          <div class="size-8 text-primary">
            <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path clip-rule="evenodd" d="M24 4H6V17.3333V30.6667H24V44H42V30.6667V17.3333H24V4Z" fill="currentColor" fill-rule="evenodd"></path>
            </svg>
          </div>
          <h1 class="text-3xl font-bold tracking-tighter text-slate-900 dark:text-white">WebDaYi</h1>
        </div>
        <p class="text-lg text-slate-600 dark:text-slate-400">ç¶²é å¤§æ˜“è¼¸å…¥æ³• <span class="font-semibold text-primary">v11.2.0</span> (ç›²æ‰“ä¿®å¾©ç‰ˆ)</p>
      </header>

      <!-- Instructions Section (hidden in express mode) -->
      <section id="instructions-section"
               class="space-y-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900/50 p-4 sm:p-6 transition-colors">
        <details class="group">
          <summary class="cursor-pointer select-none text-sm font-semibold text-slate-700 dark:text-slate-300 hover:text-primary dark:hover:text-primary transition-colors flex items-center gap-2">
            <span class="material-symbols-outlined text-base group-open:rotate-90 transition-transform">chevron_right</span>
            <span>ä½¿ç”¨èªªæ˜ (Quick Guide)</span>
          </summary>
          <div class="mt-4 space-y-3 text-sm text-slate-600 dark:text-slate-400 pl-6">
            <div class="space-y-2">
              <p class="font-medium text-slate-700 dark:text-slate-300">åŸºæœ¬æ“ä½œï¼š</p>
              <ul class="list-disc list-inside space-y-1">
                <li>åœ¨ã€Œè¼¸å…¥ç¢¼ã€æ¡†ä¸­è¼¸å…¥å¤§æ˜“ç¢¼ï¼ˆa-z, 0-9ï¼‰</li>
                <li>å€™é¸å­—æœƒå³æ™‚é¡¯ç¤º</li>
                <li>é¸å­—å¾Œæœƒ**è‡ªå‹•è¤‡è£½**åˆ°å‰ªè²¼ç°¿ï¼ˆå¯åˆ‡æ›é—œé–‰ï¼‰</li>
                <li>ä½¿ç”¨ã€Œæ¸…é™¤ã€æŒ‰éˆ•å¿«é€Ÿæ¸…ç©ºè¼¸å‡º</li>
              </ul>
            </div>
            <div class="space-y-2">
              <p class="font-medium text-slate-700 dark:text-slate-300">é¸å­—æ–¹å¼ï¼š</p>
              <ul class="list-disc list-inside space-y-1">
                <li>æŒ‰ <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">Space</kbd> é¸ç¬¬ 1 å€‹å­—</li>
                <li>æŒ‰ <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">'</kbd> <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">[</kbd> <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">]</kbd> <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">-</kbd> <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">\</kbd> é¸ç¬¬ 2-6 å€‹å­—</li>
                <li>é»æ“Šå€™é¸å­—ç›´æ¥é¸å–ï¼ˆè§¸æ§å‹å–„ï¼‰</li>
                <li>è¼¸å…¥ 2 ç¢¼å¾Œç¹¼çºŒæ‰“ç¬¬ 3 ç¢¼æœƒè‡ªå‹•é¸å–ç¬¬ 1 å€‹å­—</li>
              </ul>
            </div>
            <div class="space-y-2">
              <p class="font-medium text-slate-700 dark:text-slate-300">é€²éšåŠŸèƒ½ï¼š</p>
              <ul class="list-disc list-inside space-y-1">
                <li>æŒ‰ <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">=</kbd> æˆ–ä½¿ç”¨ã€Œä¸Šä¸€é /ä¸‹ä¸€é ã€æŒ‰éˆ•ç¿»é </li>
                <li>è¼¸å…¥æ³•æœƒå­¸ç¿’ä½ çš„é¸å­—ç¿’æ…£ä¸¦è‡ªå‹•èª¿æ•´é †åº</li>
                <li>æŒ‰ <kbd class="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs font-mono">Backspace</kbd> æ™ºæ…§åˆªé™¤ï¼ˆå…ˆåˆªè¼¸å…¥ç¢¼ï¼Œå†åˆªè¼¸å‡ºå­—å…ƒï¼‰</li>
              </ul>
            </div>
          </div>
        </details>
      </section>

      <!-- Mobile UX: Use flexbox for reordering. Desktop: preserve original order -->
      <main class="w-full flex flex-col space-y-4">

        <!-- Output Section (Top on desktop, compact on mobile) -->
        <!-- Mobile: order-1, Desktop: order-1 (same) -->
        <div class="order-1 space-y-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900/50 p-3 sm:p-6 transition-colors max-h-40 sm:max-h-none overflow-y-auto sm:overflow-visible">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">è¼¸å‡º (Output)</h2>
            <div class="flex items-center gap-2">
              <button id="copy-button"
                      class="flex h-10 cursor-pointer items-center justify-center gap-2 rounded-lg bg-primary/10 dark:bg-primary/20 px-4 text-sm font-medium text-primary hover:bg-primary/20 dark:hover:bg-primary/30 transition-all hover:shadow-md">
                <span class="material-symbols-outlined text-base">content_copy</span>
                <span>Copy</span>
              </button>
              <button id="clear-button"
                      class="flex h-10 cursor-pointer items-center justify-center gap-2 rounded-lg bg-rose-500/10 dark:bg-rose-500/20 px-4 text-sm font-medium text-rose-500 dark:text-rose-400 hover:bg-rose-500/20 dark:hover:bg-rose-500/30 transition-all hover:shadow-md">
                <span class="material-symbols-outlined text-base">delete</span>
                <span>Clear</span>
              </button>
            </div>
          </div>
          <textarea id="output-buffer"
                    class="form-textarea w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-2 text-base text-slate-900 dark:text-white placeholder:text-slate-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50 transition-colors"
                    placeholder="é¸å¥½çš„æ–‡å­—æœƒå‡ºç¾åœ¨é€™è£¡... (Selected text appears here)"
                    rows="2"></textarea>
        </div>

        <!-- v11: Sentence Mode Panel (shown in sentence mode) -->
        <!-- Mobile: order-4 (below candidates), Desktop: order-2 (above input) -->
        <div id="sentence-mode-panel" class="hidden order-4 sm:order-2 space-y-2 sm:space-y-3 rounded-xl border-2 border-primary/30 bg-gradient-to-br from-primary/5 to-purple-500/5 dark:from-primary/10 dark:to-purple-500/10 p-2 sm:p-3 transition-colors">
          <!-- Mobile: Collapsible header -->
          <div class="flex items-center justify-between sm:hidden">
            <div class="flex items-center gap-2 text-sm font-medium text-primary">
              <span class="material-symbols-outlined text-base">auto_awesome</span>
              <span>æ•´å¥æ¨¡å¼</span>
            </div>
            <button id="toggle-sentence-panel" class="flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
              <span class="material-symbols-outlined text-sm" id="panel-toggle-icon">expand_less</span>
              <span id="panel-toggle-text">æ”¶èµ·</span>
            </button>
          </div>

          <!-- Collapsible content (Mobile: can collapse, Desktop: always shown) -->
          <div id="sentence-panel-content" class="space-y-2 sm:space-y-3">
            <!-- Live Preview & Code Buffer (inline on mobile, separate on desktop) -->
            <div class="flex flex-col sm:flex-col gap-2">
              <!-- Live Preview (Hidden by default on mobile, can toggle) -->
              <div id="live-preview-container" class="hidden">
                <div class="flex items-center gap-1 sm:gap-2 text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">
                  <span class="material-symbols-outlined text-sm">visibility</span>
                  <span class="hidden sm:inline">å³æ™‚é è¦½</span>
                  <span class="sm:hidden">é è¦½</span>
                </div>
                <div id="preview-text" class="text-lg sm:text-2xl font-bold text-center sm:text-center text-slate-800 dark:text-slate-100 tracking-wider py-1 sm:py-2"></div>
              </div>

              <!-- Code Buffer Display (Compact on mobile) -->
              <div id="code-buffer-container">
                <div class="flex items-center justify-between mb-1 sm:mb-2">
                  <div class="flex items-center gap-1 sm:gap-2 text-xs font-medium text-slate-600 dark:text-slate-400">
                    <span class="material-symbols-outlined text-sm">code</span>
                    <span class="hidden sm:inline">å·²è¼¸å…¥ç·¨ç¢¼</span>
                    <span class="sm:hidden">ç·¨ç¢¼</span>
                  </div>
                  <button id="clear-buffer-btn" class="flex items-center gap-1 px-1.5 py-0.5 sm:px-2 rounded text-xs font-medium text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 transition-colors" title="æ¸…é™¤ç·©è¡å€ (ESC)">
                    <span class="material-symbols-outlined text-sm">backspace</span>
                    <span class="hidden sm:inline">æ¸…é™¤</span>
                  </button>
                </div>
                <div id="buffered-codes" class="flex flex-wrap gap-1 sm:gap-2 min-h-6 sm:min-h-10 items-center">
                  <span class="text-xs sm:text-sm text-slate-400 dark:text-slate-500 italic">å°šç„¡ç·¨ç¢¼</span>
                </div>
              </div>
            </div>

            <!-- Confirm Prediction Button (compact on mobile) -->
            <button id="predict-sentence-btn"
                    class="w-full flex items-center justify-center gap-2 px-3 sm:px-4 py-1.5 sm:py-3 rounded-lg bg-gradient-to-r from-primary to-purple-500 hover:from-primary/90 hover:to-purple-500/90 text-white font-semibold text-sm transition-all shadow-md hover:shadow-lg active:scale-98 disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="material-symbols-outlined text-base sm:text-lg">check_circle</span>
              <span class="text-xs sm:text-sm">ç¢ºèªé æ¸¬ (=)</span>
            </button>
          </div>
        </div>

        <!-- Input Section -->
        <!-- Mobile: order-2 (above candidates), Desktop: order-3 (after sentence panel) -->
        <div class="order-2 sm:order-3 space-y-3 sm:space-y-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900/50 p-3 sm:p-6 transition-colors">
          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700 dark:text-slate-300" for="input-box">
              è¼¸å…¥ç¢¼ (Dayi Input)
            </label>
            <input id="input-box"
                   type="text"
                   autofocus
                   autocomplete="off"
                   spellcheck="false"
                   class="form-input h-12 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 px-4 text-lg text-slate-900 dark:text-white placeholder:text-slate-400 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono transition-colors"
                   placeholder="è¼¸å…¥å¤§æ˜“ç¢¼... (e.g., 'f' for 'ä½ ')"/>
          </div>

          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700 dark:text-slate-300">
              å€™é¸å­— (Candidates)
            </label>
            <div id="candidate-area"
                 class="flex min-h-12 flex-wrap items-center gap-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/30 p-2 transition-colors">
              <div class="w-full text-center text-sm text-slate-400 py-1">è«‹è¼¸å…¥å¤§æ˜“ç¢¼</div>
            </div>
          </div>
        </div>

        <!-- ğŸ†• Phase 1.10.4: Finish Editing Hint -->
        <div id="finish-hint"
             class="hidden text-center py-3 px-4 rounded-lg bg-gradient-to-r from-green-500/10 to-teal-500/10 border border-green-500/30 dark:border-green-400/30 animate-pulse"
             style="animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
          <div class="flex items-center justify-center gap-2 text-green-600 dark:text-green-400">
            <span class="material-symbols-outlined text-lg">check_circle</span>
            <span class="font-medium">ç·¨è¼¯å®Œæˆï¼æŒ‰ <kbd class="px-2 py-1 bg-white dark:bg-slate-700 border border-green-500/50 rounded text-sm font-mono">Enter</kbd> é€å‡ºåˆ°è¼¸å‡ºå€</span>
          </div>
        </div>

        <!-- Status Message -->
        <div id="status-message"
             class="flex items-center justify-center gap-2 rounded-full bg-slate-200 dark:bg-slate-800 px-3 py-1.5 text-xs text-slate-600 dark:text-slate-400 transition-colors">
          <span class="material-symbols-outlined text-sm">info</span>
          <span>è¼‰å…¥ä¸­... (Loading...)</span>
        </div>

        <!-- Debug Section (hidden in express mode) -->
        <!-- PWA: UserDB Statistics Section -->
        <div id="userdb-stats-section"
             class="rounded-xl border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/20 p-3 transition-colors mb-3">
          <details class="group">
            <summary class="cursor-pointer select-none text-sm font-medium text-green-700 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 transition-colors flex items-center gap-2">
              <span class="material-symbols-outlined text-base group-open:rotate-90 transition-transform">chevron_right</span>
              <span>Learning Statistics (PWA)</span>
            </summary>

            <!-- UserDB Status -->
            <div id="userdb-status" class="mt-3 px-3 py-2 text-xs text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-900 rounded-lg border border-green-200 dark:border-green-700">
              â³ IndexedDB Loading...
            </div>

            <!-- Stats Display -->
            <div id="userdb-stats" class="mt-3 text-xs text-slate-600 dark:text-slate-400 space-y-1">
              <p class="text-slate-500 dark:text-slate-500">No learning data yet. Start using the input method to learn your preferences!</p>
            </div>

            <!-- Learning Data Management Buttons -->
            <div class="mt-4 flex flex-wrap gap-2">
              <!-- Export Button -->
              <button onclick="exportLearnedPatterns()"
                      class="flex h-9 items-center gap-2 rounded-lg bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 px-3 text-xs font-medium text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-900/50 transition-all"
                      aria-label="åŒ¯å‡ºå­¸ç¿’è³‡æ–™">
                <span class="material-symbols-outlined text-sm">download</span>
                <span>Export</span>
              </button>

              <!-- Import Button -->
              <button onclick="importLearnedPatterns()"
                      class="flex h-9 items-center gap-2 rounded-lg bg-blue-100 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-700 px-3 text-xs font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all"
                      aria-label="åŒ¯å…¥å­¸ç¿’è³‡æ–™">
                <span class="material-symbols-outlined text-sm">upload</span>
                <span>Import</span>
              </button>

              <!-- Clear All Button -->
              <button onclick="clearAllPatterns()"
                      class="flex h-9 items-center gap-2 rounded-lg bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 px-3 text-xs font-medium text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all"
                      aria-label="æ¸…é™¤æ‰€æœ‰å­¸ç¿’è³‡æ–™">
                <span class="material-symbols-outlined text-sm">delete_sweep</span>
                <span>Clear</span>
              </button>
            </div>
          </details>
        </div>

        <div id="debug-section"
             class="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/30 p-4 transition-colors">
          <details class="group">
            <summary class="cursor-pointer select-none text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center gap-2">
              <span class="material-symbols-outlined text-base group-open:rotate-90 transition-transform">chevron_right</span>
              <span>Debug Information</span>
            </summary>
            <div id="debug-info" class="mt-3 text-xs font-mono text-slate-500 dark:text-slate-500 space-y-1">
              <p>Database loading...</p>
            </div>
          </details>
        </div>
      </main>

      <!-- Footer (hidden in express mode) -->
      <footer id="app-footer"
              class="text-center text-sm text-slate-500 dark:text-slate-500 pb-4 transition-colors">
        <p>
          WebDaYi PWA v0.5.0 - Progressive Web App with Personalized Learning
          <br>
          <span class="text-xs">
            Data source: <a href="https://github.com/rime/rime-dayi" target="_blank" class="text-primary hover:underline">Rime DÃ yÃ¬ Dictionary</a> +
            <a href="https://github.com/rime/rime-essay" target="_blank" class="text-primary hover:underline">Rime Essay (N-gram)</a>
            <br>
            <span class="text-green-600 dark:text-green-400">âœ“ Offline-First | âœ“ IndexedDB Learning | âœ“ Mobile Keyboard</span>
          </span>
        </p>
      </footer>

    </div>
  </div>

  <!-- v11: N-gram Loading Indicator -->
  <div id="ngram-loading" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-xl p-8 shadow-2xl max-w-sm mx-4 text-center">
      <div class="w-16 h-16 mx-auto mb-4 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
      <div class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-2">è¼‰å…¥ N-gram è³‡æ–™åº«</div>
      <div class="text-sm text-slate-500 dark:text-slate-400">é¦–æ¬¡ä½¿ç”¨éœ€è¼‰å…¥ 10MB è³‡æ–™...</div>
    </div>
  </div>

  <!-- Version Information Script -->
  <script>
    // Version information (for testing verification)
    window.WEBDAYI_VERSION = {
      version: '11.2.1',
      build: '20251112-015',
      buildDate: '2025-11-12T00:00:00Z',
      commit: '4235471',
      releaseName: 'Chinese Text Recognition Diagnostics',
      changes: [
        'v2.7: Upgraded to hybrid implementation (best of both worlds)',
        'Architecture: v2.6 OOP design (clean, modular structure)',
        'Algorithm: v2.5 proven 70/30 weights + Laplace smoothing',
        'Accuracy: 94.4% (Test 1: 100%, Test 2: 90%)',
        'Code quality: Adjustable BIGRAM_WEIGHT/UNIGRAM_WEIGHT constants',
        '--- Benefits ---',
        'Easier to understand (clear OOP architecture)',
        'Easier to maintain (modular design)',
        'Easier to tune (adjustable weight parameters)',
        'Same accuracy as v2.5 (proven 90%+)'
      ]
    };

    // Display version in console for easy verification
    console.log('%cğŸš€ WebDaYi MVP 1.0', 'font-size: 16px; font-weight: bold; color: #3b82f6;');
    console.log('%cVersion: ' + window.WEBDAYI_VERSION.version, 'font-size: 14px; color: #10b981;');
    console.log('%cBuild: 20251112-015', 'font-size: 12px; color: #8b5cf6;');
    console.log('%cCommit: 4235471', 'font-size: 12px; color: #ec4899;');
    console.log('%cRelease: ' + window.WEBDAYI_VERSION.releaseName, 'font-size: 12px; color: #6b7280;');
    console.log('%c' + '-'.repeat(50), 'color: #d1d5db;');
    console.log('%cLatest Changes:', 'font-size: 12px; font-weight: bold; color: #f59e0b;');
    window.WEBDAYI_VERSION.changes.forEach((change, i) => {
      console.log('%c  ' + (i + 1) + '. ' + change, 'font-size: 11px; color: #9ca3af;');
    });
    console.log('%c' + '-'.repeat(50), 'color: #d1d5db;');
    console.log('%cTo check version: window.WEBDAYI_VERSION', 'font-size: 11px; color: #6b7280; font-style: italic;');
  </script>

  <!-- Core Logic -->
  <script src="js/core_logic.js"></script>

  <!-- v11: N-gram Sentence Prediction -->
  <!-- CACHE BUSTER: Version parameter forces browser to reload JavaScript -->
  <script src="js/viterbi_module.js?v=11.3.5-009"></script>
  <script src="js/core_logic_v11.js?v=11.3.3-007"></script>
  <script src="js/core_logic_v11_ui.js?v=11.3.3-007"></script>

  <!-- Dark Mode Toggle Script -->
  <script>
    // Dark mode toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const htmlElement = document.documentElement;

    // Check saved preference or system preference
    const darkModePreference = localStorage.getItem('darkMode');
    if (darkModePreference === 'false') {
      htmlElement.classList.remove('dark');
    } else if (darkModePreference === null) {
      // Default to system preference
      if (!window.matchMedia('(prefers-color-scheme: dark)').matches) {
        htmlElement.classList.remove('dark');
      }
    }

    darkModeToggle.addEventListener('click', () => {
      htmlElement.classList.toggle('dark');
      const isDark = htmlElement.classList.contains('dark');
      localStorage.setItem('darkMode', isDark);

      // Update icon
      const icon = darkModeToggle.querySelector('.material-symbols-outlined');
      icon.textContent = isDark ? 'light_mode' : 'dark_mode';
      const label = darkModeToggle.querySelector('span:not(.material-symbols-outlined)');
      if (label) label.textContent = isDark ? 'Light' : 'Dark';
    });

    // Set initial icon
    const isDark = htmlElement.classList.contains('dark');
    const icon = darkModeToggle.querySelector('.material-symbols-outlined');
    icon.textContent = isDark ? 'light_mode' : 'dark_mode';
    const label = darkModeToggle.querySelector('span:not(.material-symbols-outlined)');
    if (label) label.textContent = isDark ? 'Light' : 'Dark';
  </script>

  <!-- Update debug info and status after loading -->
  <script>
    setTimeout(() => {
      const debugInfo = document.getElementById('debug-info');
      const statusMessage = document.getElementById('status-message');

      if (debugInfo && typeof dayiMap !== 'undefined' && dayiMap) {
        debugInfo.innerHTML = `
          <p><strong>Database Status:</strong> âœ“ Loaded</p>
          <p><strong>Total Codes:</strong> ${dayiMap.size.toLocaleString()}</p>
          <p><strong>Sample Queries:</strong></p>
          <ul class="ml-4 mt-1 space-y-0.5">
            <li><code class="text-primary">'v'</code> â†’ ${queryCandidates(dayiMap, 'v').slice(0, 3).map(c => c.char).join(', ')}</li>
            <li><code class="text-primary">'a'</code> â†’ ${queryCandidates(dayiMap, 'a').slice(0, 3).map(c => c.char).join(', ')}</li>
          </ul>
        `;
      }

      if (statusMessage && typeof dayiMap !== 'undefined' && dayiMap) {
        statusMessage.innerHTML = `
          <span class="material-symbols-outlined text-base text-green-500">check_circle</span>
          <span>å­—å…¸è¼‰å…¥å®Œæˆï¼å·²è¼‰å…¥ ${dayiMap.size.toLocaleString()} å€‹å­—ç¢¼</span>
        `;
      }
    }, 1000);
  </script>

  <!-- Add custom animation -->
  <style>
    @keyframes slide-in {
      from {
        transform: translateY(1rem);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .animate-slide-in {
      animation: slide-in 0.3s ease-out;
    }

    /* v11: Mode Toggle Styles */
    .mode-btn {
      background: transparent;
      color: var(--tw-text-opacity);
    }
    .mode-btn:hover {
      background: rgba(15, 184, 240, 0.1);
    }
    .mode-btn.active {
      background: #0fb8f0;
      color: white;
      box-shadow: 0 2px 8px rgba(15, 184, 240, 0.3);
    }

    /* v11: Buffered Code Badges */
    .buffered-code-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.375rem 0.75rem;
      background: #0fb8f0;
      color: white;
      border-radius: 0.375rem;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      font-size: 0.875rem;
      animation: slide-in 0.2s ease-out;
    }
    .dark .buffered-code-badge {
      background: #0fb8f0;
    }

    /* v11: Sentence Prediction Result */
    .sentence-prediction {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      animation: slide-in 0.3s ease-out;
    }
    .prediction-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
      opacity: 0.9;
    }
    .predicted-sentence {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: 0.2em;
      margin: 1rem 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .prediction-details {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 0.875rem;
    }
    .char-breakdown {
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .prediction-score {
      text-align: center;
      opacity: 0.8;
    }

    /* ğŸ†• Phase 1.10.1: Character Span Display */
    .sentence-display {
      display: flex;
      gap: 4px;
      padding: 12px;
      background: rgba(78, 201, 176, 0.05);
      border-radius: 8px;
      outline: none;
      justify-content: center;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .char-span {
      display: inline-block;
      padding: 6px 12px;
      font-size: 2rem;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      user-select: none;
      background: rgba(255, 255, 255, 0.1);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .char-span:hover {
      background: rgba(78, 201, 176, 0.3);
      transform: scale(1.15);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .char-span.editing {
      background: rgba(78, 201, 176, 0.4);
      border: 2px solid #4ec9b0;
      box-shadow: 0 0 12px rgba(78, 201, 176, 0.6);
    }

    /* ğŸ†• Phase 1.10.3: Focused state for arrow navigation */
    .char-span.focused {
      background: rgba(78, 201, 176, 0.2);
      border: 2px solid rgba(78, 201, 176, 0.6);
      box-shadow: 0 0 8px rgba(78, 201, 176, 0.4);
      outline: 2px solid rgba(78, 201, 176, 0.3);
      outline-offset: 2px;
    }

    @media (max-width: 640px) {
      .mode-btn span:not(.material-symbols-outlined) {
        display: none;
      }
      .predicted-sentence {
        font-size: 1.5rem;
      }
      .char-span {
        font-size: 1.5rem;
        padding: 4px 10px;
      }
    }

    /* ğŸ†• Phase 1.10.2: Candidate Selection Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .modal-backdrop.hidden {
      display: none;
    }

    .candidate-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      min-width: 400px;
      max-width: 90vw;
      animation: modal-fade-in 0.2s ease-out;
    }

    .candidate-modal.hidden {
      display: none;
    }

    @keyframes modal-fade-in {
      from {
        opacity: 0;
        transform: translate(-50%, -48%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .modal-title {
      font-size: 1.1em;
      font-weight: 600;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .candidate-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 1.3em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .candidate-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.05);
    }

    .candidate-btn:active {
      transform: scale(0.98);
    }

    .candidate-char {
      font-size: 1.2em;
    }

    .candidate-key {
      background: rgba(78, 201, 176, 0.4);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7em;
      font-family: 'Courier New', monospace;
      font-weight: 500;
    }

    .modal-hint {
      text-align: center;
      font-size: 0.85em;
      opacity: 0.9;
    }

    @media (max-width: 640px) {
      .candidate-modal {
        min-width: 320px;
        max-width: 95vw;
        padding: 20px;
      }

      .candidates-grid {
        gap: 8px;
      }

      .candidate-btn {
        padding: 10px 12px;
        font-size: 1.1em;
      }

      .candidate-key {
        font-size: 0.65em;
        padding: 3px 7px;
      }
    }

    /* PWA: Mobile Custom Touch Keyboard (RWD) */
    .mobile-keyboard {
      display: none; /* Hidden on desktop */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.05)),
                  #f1f5f9;
      border-top: 2px solid #cbd5e1;
      padding: 8px;
      z-index: 1000;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1),
                  0 -2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .dark .mobile-keyboard {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.05)),
                  #1e293b;
      border-top-color: #475569;
    }

    .keyboard-row {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
      justify-content: center;
    }

    .keyboard-row:last-child {
      margin-bottom: 0;
    }

    .key-btn {
      flex: 1;
      min-width: 0;
      height: 44px;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      color: #1e293b;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.15s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .dark .key-btn {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }

    .key-btn:active {
      transform: scale(0.95);
      background: #0fb8f0;
      color: white;
      border-color: #0fb8f0;
      box-shadow: 0 0 0 3px rgba(15, 184, 240, 0.2);
    }

    .dark .key-btn:active {
      background: #0fb8f0;
      border-color: #0fb8f0;
    }

    /* Trapezoid Layout - Row 4 */
    .key-wide {
      flex: 1.5; /* Shift and Backspace in Row 4 */
    }

    .key-shift {
      background: #64748b;
      border-color: #475569;
      color: white;
    }

    .dark .key-shift {
      background: #475569;
      border-color: #334155;
    }

    .key-backspace {
      background: #64748b;
      border-color: #475569;
      color: white;
    }

    .dark .key-backspace {
      background: #475569;
      border-color: #334155;
    }

    /* Control Row - Row 5 */
    .key-small {
      flex: 0.8; /* Punctuation keys: , . / */
    }

    .key-medium {
      flex: 1.2; /* = key for sentence prediction */
    }

    .key-super-wide {
      flex: 4; /* Space bar - largest key */
    }

    .key-equals {
      background: #0fb8f0;
      border-color: #0891b2;
      color: white;
      font-size: 20px;
      font-weight: 700;
    }

    .dark .key-equals {
      background: #0891b2;
      border-color: #0e7490;
    }

    .key-punct {
      background: #f1f5f9;
      border-color: #cbd5e1;
      color: #1e293b;
    }

    .dark .key-punct {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }

    .key-space {
      background: #cbd5e1;
      border-color: #94a3b8;
      color: #1e293b;
      font-size: 14px;
    }

    .dark .key-space {
      background: #475569;
      border-color: #334155;
      color: #94a3b8;
    }

    .space-text {
      font-size: 12px;
      font-weight: 500;
      opacity: 0.7;
    }

    .control-row {
      gap: 5px;
    }

    /* Show keyboard on mobile */
    @media (max-width: 768px) {
      .mobile-keyboard {
        display: block;
      }

      /* Add bottom padding to main content to prevent keyboard overlap */
      /* Reduced from 280px to 265px for better candidate visibility */
      #app-container {
        padding-bottom: 265px;
      }

      /* Prevent input mode "none" attribute from being overridden */
      #input-box[inputmode="none"]:focus {
        caret-color: auto;
      }
    }

    /* Keyboard haptic feedback animation */
    @keyframes key-press {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(0.95);
      }
      100% {
        transform: scale(1);
      }
    }

    .key-btn.pressed {
      animation: key-press 0.1s ease;
    }
  </style>

  <!-- PWA: IndexedDB Module -->
  <script type="module" src="js/user_db_indexeddb.js"></script>

  <!-- PWA: Service Worker Registration -->
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('%c[PWA] Service Worker registered successfully', 'color: #4ec9b0; font-weight: bold');
            console.log('Scope:', registration.scope);

            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60000); // Check every minute
          })
          .catch(error => {
            console.error('[PWA] Service Worker registration failed:', error);
          });
      });

      // Handle Service Worker updates
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('[PWA] New Service Worker activated');
        // Optionally reload the page to get the latest version
        // window.location.reload();
      });
    } else {
      console.warn('[PWA] Service Workers are not supported in this browser');
    }
  </script>

  <!-- PWA: IndexedDB Integration & Export/Import -->
  <script type="module">
    import { UserDB } from './js/user_db_indexeddb.js';

    // Initialize UserDB
    let userDB = null;
    let userDBReady = false;

    async function initUserDB() {
      try {
        userDB = new UserDB();
        await userDB.open();
        userDBReady = true;

        // ğŸ†• Phase 1: Make UserDB globally accessible for Viterbi integration
        window.userDB = userDB;
        window.userDBReady = true;

        console.log('%c[PWA] IndexedDB initialized successfully', 'color: #4ec9b0; font-weight: bold');
        console.log('%c[Phase 1] UserDB now available globally for learning integration', 'color: #4ec9b0; font-weight: bold');

        // Update UI (both desktop and mobile)
        const dbStatus = document.getElementById('userdb-status');
        const dbStatusMobile = document.getElementById('userdb-status-mobile');

        if (dbStatus) {
          dbStatus.innerHTML = 'âœ“ IndexedDB Ready (Learning Enabled)';
          dbStatus.className = 'mt-3 px-3 py-2 text-xs text-green-600 dark:text-green-400 bg-white dark:bg-slate-900 rounded-lg border border-green-200 dark:border-green-700';
        }

        if (dbStatusMobile) {
          dbStatusMobile.innerHTML = 'âœ“ IndexedDB Ready';
          dbStatusMobile.className = 'text-center text-green-600 dark:text-green-400';
        }

        // Get and display stats
        updateUserDBStats();
      } catch (error) {
        console.error('[PWA] IndexedDB initialization failed:', error);
        window.userDB = null;
        window.userDBReady = false;

        const dbStatus = document.getElementById('userdb-status');
        const dbStatusMobile = document.getElementById('userdb-status-mobile');

        if (dbStatus) {
          dbStatus.innerHTML = 'âœ— IndexedDB Error';
          dbStatus.className = 'mt-3 px-3 py-2 text-xs text-red-600 dark:text-red-400 bg-white dark:bg-slate-900 rounded-lg border border-red-200 dark:border-red-700';
        }

        if (dbStatusMobile) {
          dbStatusMobile.innerHTML = 'âœ— IndexedDB Error';
          dbStatusMobile.className = 'text-center text-red-600 dark:text-red-400';
        }
      }
    }

    async function updateUserDBStats() {
      if (!userDB) return;

      try {
        const stats = await userDB.getStats();
        const statsElement = document.getElementById('userdb-stats');
        if (statsElement) {
          statsElement.innerHTML = `
            <div class="text-sm text-slate-600 dark:text-slate-400">
              <p><strong>Learned Patterns:</strong> ${stats.count}</p>
              <p><strong>Avg Weight:</strong> ${stats.avgWeight.toFixed(3)}</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('[PWA] Failed to get UserDB stats:', error);
      }
    }

    // Export learned patterns
    async function exportLearnedPatterns() {
      if (!userDB) {
        alert('IndexedDB not ready. Please wait a moment and try again.');
        return;
      }

      try {
        const weights = await userDB.getAllWeights();
        const exportData = {
          version: "1.0.0",
          exported: new Date().toISOString(),
          count: Object.keys(weights).length,
          data: weights
        };

        const jsonString = JSON.stringify(exportData, null, 2);
        const fileName = `webdayi_learned_patterns_${new Date().toISOString().split('T')[0]}.json`;

        // Mobile: Use Web Share API if available (better mobile support)
        if (isMobile() && navigator.canShare && navigator.share) {
          try {
            const file = new File([jsonString], fileName, {
              type: 'application/json'
            });

            // Check if files can be shared
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: 'WebDaYi å­¸ç¿’è¨˜éŒ„',
                text: `åŒ¯å‡º ${exportData.count} ç­†å­¸ç¿’è¨˜éŒ„`
              });
              console.log(`[PWA] Shared ${exportData.count} learned patterns via Web Share API`);
              return;
            }
          } catch (shareError) {
            // If share was cancelled or failed, fall through to download
            console.log('[PWA] Share cancelled or not supported, falling back to download');
          }
        }

        // Desktop or fallback: Create blob and download
        const blob = new Blob([jsonString], {
          type: 'application/json'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;

        // For mobile: must append to body before click (iOS requirement)
        document.body.appendChild(a);
        a.click();

        // Clean up after a delay (iOS needs time)
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);

        console.log(`[PWA] Exported ${exportData.count} learned patterns`);
        alert(`Successfully exported ${exportData.count} learned patterns!`);
      } catch (error) {
        console.error('[PWA] Export failed:', error);
        alert('Export failed. Please check the console for details.');
      }
    }

    // Import learned patterns
    async function importLearnedPatterns() {
      if (!userDB) {
        alert('IndexedDB not ready. Please wait a moment and try again.');
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';

      input.onchange = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const importData = JSON.parse(text);

          // Validate format
          if (!importData.version || !importData.data) {
            throw new Error('Invalid file format');
          }

          // Import weights
          await userDB.importWeights(importData.data);

          console.log(`[PWA] Imported ${importData.count} learned patterns`);
          alert(`Successfully imported ${importData.count} learned patterns!`);

          // Update stats
          updateUserDBStats();
        } catch (error) {
          console.error('[PWA] Import failed:', error);
          alert('Import failed. Please check the file format and try again.');
        }
      };

      input.click();
    }

    // Clear all learned patterns
    async function clearAllPatterns() {
      if (!userDB) {
        alert('IndexedDB not ready. Please wait a moment and try again.');
        return;
      }

      const confirmed = confirm('Are you sure you want to clear all learned patterns? This cannot be undone.');
      if (!confirmed) return;

      try {
        await userDB.clearAll();
        console.log('[PWA] Cleared all learned patterns');
        alert('All learned patterns have been cleared.');

        // Update stats
        updateUserDBStats();
      } catch (error) {
        console.error('[PWA] Clear failed:', error);
        alert('Clear failed. Please check the console for details.');
      }
    }

    // Initialize UserDB when page loads
    window.addEventListener('load', () => {
      initUserDB();
    });

    // Expose functions globally for button handlers
    window.exportLearnedPatterns = exportLearnedPatterns;
    window.importLearnedPatterns = importLearnedPatterns;
    window.clearAllPatterns = clearAllPatterns;
    window.updateUserDBStats = updateUserDBStats;
  </script>

  <!-- Mobile: Collapsible Sentence Panel Logic -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const toggleButton = document.getElementById('toggle-sentence-panel');
      const panelContent = document.getElementById('sentence-panel-content');
      const toggleIcon = document.getElementById('panel-toggle-icon');
      const toggleText = document.getElementById('panel-toggle-text');

      if (toggleButton && panelContent && toggleIcon && toggleText) {
        let isExpanded = true; // Default: expanded

        toggleButton.addEventListener('click', () => {
          isExpanded = !isExpanded;

          if (isExpanded) {
            // Expand
            panelContent.classList.remove('hidden');
            toggleIcon.textContent = 'expand_less';
            toggleText.textContent = 'æ”¶èµ·';
          } else {
            // Collapse
            panelContent.classList.add('hidden');
            toggleIcon.textContent = 'expand_more';
            toggleText.textContent = 'å±•é–‹';
          }
        });

        console.log('[PWA] Collapsible sentence panel initialized');
      }
    });
  </script>

  <!-- PWA: Unified Input Handler (Desktop + Mobile) -->
  <script>
    /**
     * Unified Input Handler for PWA
     * Handles both desktop physical keyboard and mobile touch keyboard
     * Uses same core_logic.js for both input sources
     */

    // Detect if mobile
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Prevent system keyboard on mobile
    function preventSystemKeyboard() {
      if (isMobile()) {
        const inputBox = document.getElementById('input-box');
        if (inputBox) {
          inputBox.setAttribute('inputmode', 'none');
          console.log('[PWA] System keyboard prevented on mobile');
        }
      }
    }

    // Haptic feedback for touch
    function triggerHaptic() {
      if ('vibrate' in navigator) {
        navigator.vibrate(50); // 50ms vibration
      }
    }

    // Visual feedback for key press
    function animateKeyPress(button) {
      button.classList.add('pressed');
      setTimeout(() => {
        button.classList.remove('pressed');
      }, 100);
    }

    // Initialize mobile keyboard
    function initMobileKeyboard() {
      const keyboard = document.getElementById('custom-keyboard');
      if (!keyboard) return;

      // Add touch event listeners to all key buttons
      const keyButtons = keyboard.querySelectorAll('.key-btn');

      keyButtons.forEach(button => {
        // Use touchstart for faster response
        button.addEventListener('touchstart', (e) => {
          e.preventDefault(); // Prevent default touch behavior

          const key = button.dataset.key;

          // Trigger haptic feedback
          triggerHaptic();

          // Animate button
          animateKeyPress(button);

          // Get input box
          const inputBox = document.getElementById('input-box');
          if (!inputBox) return;

          // Handle different key types
          // Note: Synthetic KeyboardEvent doesn't update input.value automatically (browser security)
          // We need to manually update the value and trigger events

          if (key === 'Shift') {
            // Shift key - Toggle language mode (English/Chinese)
            // This calls the same logic as desktop Shift key
            const shiftEvent = new KeyboardEvent('keydown', {
              key: 'Shift',
              code: 'ShiftLeft',
              keyCode: 16,
              which: 16,
              shiftKey: true,
              bubbles: true,
              cancelable: true
            });
            inputBox.dispatchEvent(shiftEvent);

            console.log('[PWA] Mobile Shift pressed - language mode toggle');
            return;
          } else if (key === 'Backspace') {
            // Remove last character
            inputBox.value = inputBox.value.slice(0, -1);

            // Trigger input event so core_logic.js processes the change
            const inputEvent = new Event('input', { bubbles: true, cancelable: true });
            inputBox.dispatchEvent(inputEvent);

            console.log(`[PWA] Mobile Backspace pressed, value: "${inputBox.value}"`);
          } else if (key === 'Enter') {
            // Dispatch Enter keydown event
            const enterEvent = new KeyboardEvent('keydown', {
              key: 'Enter',
              code: 'Enter',
              keyCode: 13,
              which: 13,
              bubbles: true,
              cancelable: true
            });
            inputBox.dispatchEvent(enterEvent);

            console.log(`[PWA] Mobile Enter pressed`);
          } else if (key === ' ') {
            // Dispatch Space keydown event (for sentence mode prediction)
            const spaceEvent = new KeyboardEvent('keydown', {
              key: ' ',
              code: 'Space',
              keyCode: 32,
              which: 32,
              bubbles: true,
              cancelable: true
            });
            inputBox.dispatchEvent(spaceEvent);

            console.log(`[PWA] Mobile Space pressed`);
          } else if (key === '=') {
            // Dispatch = keydown event (for sentence mode pagination/prediction)
            const equalsEvent = new KeyboardEvent('keydown', {
              key: '=',
              code: 'Equal',
              keyCode: 61,
              which: 61,
              bubbles: true,
              cancelable: true
            });
            inputBox.dispatchEvent(equalsEvent);

            console.log(`[PWA] Mobile = pressed - trigger prediction`);
          } else {
            // Regular character key - manually update input value
            inputBox.value += key;

            // Trigger input event so core_logic.js can process it
            const inputEvent = new Event('input', { bubbles: true, cancelable: true });
            inputBox.dispatchEvent(inputEvent);

            console.log(`[PWA] Mobile key pressed: ${key}, input value: "${inputBox.value}"`);
          }
        });

        // Also add click for desktop testing
        button.addEventListener('click', (e) => {
          if (!isMobile()) return; // Only on mobile

          const key = button.dataset.key;

          // Simulate keyboard event
          const event = new KeyboardEvent('keydown', {
            key: key,
            code: key === ' ' ? 'Space' : (key === 'Backspace' ? 'Backspace' : `Key${key.toUpperCase()}`),
            keyCode: key.charCodeAt(0),
            which: key.charCodeAt(0),
            bubbles: true,
            cancelable: true
          });

          const inputBox = document.getElementById('input-box');
          if (inputBox) {
            inputBox.dispatchEvent(event);
          }
        });
      });

      console.log('[PWA] Mobile keyboard initialized with', keyButtons.length, 'keys');
    }

    // Initialize on page load
    window.addEventListener('load', () => {
      preventSystemKeyboard();
      initMobileKeyboard();

      // Log input mode
      if (isMobile()) {
        console.log('%c[PWA] Mobile mode: Custom touch keyboard enabled', 'color: #0fb8f0; font-weight: bold');
      } else {
        console.log('%c[PWA] Desktop mode: Physical keyboard enabled', 'color: #0fb8f0; font-weight: bold');
      }
    });

    // Re-check on resize (orientation change)
    window.addEventListener('resize', () => {
      preventSystemKeyboard();
    });
  </script>

  <!-- Mobile Custom Touch Keyboard (RWD) - Trapezoid Layout -->
  <div id="custom-keyboard" class="mobile-keyboard">
    <!-- Row 1: Number Keys (1-0, 10 keys) -->
    <div class="keyboard-row row-numbers">
      <button class="key-btn key-num" data-key="1">1</button>
      <button class="key-btn key-num" data-key="2">2</button>
      <button class="key-btn key-num" data-key="3">3</button>
      <button class="key-btn key-num" data-key="4">4</button>
      <button class="key-btn key-num" data-key="5">5</button>
      <button class="key-btn key-num" data-key="6">6</button>
      <button class="key-btn key-num" data-key="7">7</button>
      <button class="key-btn key-num" data-key="8">8</button>
      <button class="key-btn key-num" data-key="9">9</button>
      <button class="key-btn key-num" data-key="0">0</button>
    </div>

    <!-- Row 2: QWERTY Top Row (q-p, 10 keys) -->
    <div class="keyboard-row row-qwerty">
      <button class="key-btn key-letter" data-key="q">q</button>
      <button class="key-btn key-letter" data-key="w">w</button>
      <button class="key-btn key-letter" data-key="e">e</button>
      <button class="key-btn key-letter" data-key="r">r</button>
      <button class="key-btn key-letter" data-key="t">t</button>
      <button class="key-btn key-letter" data-key="y">y</button>
      <button class="key-btn key-letter" data-key="u">u</button>
      <button class="key-btn key-letter" data-key="i">i</button>
      <button class="key-btn key-letter" data-key="o">o</button>
      <button class="key-btn key-letter" data-key="p">p</button>
    </div>

    <!-- Row 3: Home Row (a-;, 10 keys) -->
    <div class="keyboard-row row-home">
      <button class="key-btn key-letter" data-key="a">a</button>
      <button class="key-btn key-letter" data-key="s">s</button>
      <button class="key-btn key-letter" data-key="d">d</button>
      <button class="key-btn key-letter" data-key="f">f</button>
      <button class="key-btn key-letter" data-key="g">g</button>
      <button class="key-btn key-letter" data-key="h">h</button>
      <button class="key-btn key-letter" data-key="j">j</button>
      <button class="key-btn key-letter" data-key="k">k</button>
      <button class="key-btn key-letter" data-key="l">l</button>
      <button class="key-btn key-letter" data-key=";">;</button>
    </div>

    <!-- Row 4: Bottom Row - Trapezoid Layout (Shift + z-m + Backspace) -->
    <div class="keyboard-row row-bottom">
      <button class="key-btn key-shift key-wide" data-key="Shift">
        <span class="material-symbols-outlined">arrow_upward</span>
      </button>
      <button class="key-btn key-letter" data-key="z">z</button>
      <button class="key-btn key-letter" data-key="x">x</button>
      <button class="key-btn key-letter" data-key="c">c</button>
      <button class="key-btn key-letter" data-key="v">v</button>
      <button class="key-btn key-letter" data-key="b">b</button>
      <button class="key-btn key-letter" data-key="n">n</button>
      <button class="key-btn key-letter" data-key="m">m</button>
      <button class="key-btn key-backspace key-wide" data-key="Backspace">
        <span class="material-symbols-outlined">backspace</span>
      </button>
    </div>

    <!-- Row 5: Control Keys (= key + Punctuation + Space) -->
    <div class="keyboard-row control-row">
      <button class="key-btn key-equals key-medium" data-key="=" title="æ•´å¥æ¨¡å¼é æ¸¬">
        =
      </button>
      <button class="key-btn key-punct key-small" data-key=",">,</button>
      <button class="key-btn key-space key-super-wide" data-key=" ">
        <span class="space-text">Space</span>
      </button>
      <button class="key-btn key-punct key-small" data-key=".">.</button>
      <button class="key-btn key-punct key-small" data-key="/">/</button>
    </div>
  </div>

  <!-- ğŸ†• Phase 1.10.2: Candidate Selection Modal -->
  <!-- Modal Backdrop -->
  <div id="modal-backdrop" class="modal-backdrop hidden"></div>

  <!-- Candidate Modal -->
  <div id="candidate-modal" class="candidate-modal hidden">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">é¸æ“‡å­—å…ƒ</span>
      <button class="close-btn" id="close-modal-btn" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div class="candidates-grid" id="candidates-grid">
      <!-- Candidates will be populated dynamically -->
    </div>
    <div class="modal-hint">
      ä½¿ç”¨éµç›¤å¿«æ·éµæˆ–é»æ“Šé¸æ“‡ | <kbd>Esc</kbd> å–æ¶ˆ
    </div>
  </div>

</body>
</html>
