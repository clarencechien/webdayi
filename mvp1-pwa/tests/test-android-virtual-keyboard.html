<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Android Virtual Keyboard Fix - TDD Tests</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
    }
    .test-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    h2 {
      color: #764ba2;
      margin-top: 30px;
      border-left: 4px solid #764ba2;
      padding-left: 15px;
    }
    .test-result {
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 6px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }
    .pass {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .fail {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      padding: 10px;
      border-radius: 6px;
      border-left: 4px solid #17a2b8;
      margin: 10px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ Android Virtual Keyboard Fix - TDD Test Suite</h1>

    <div class="info">
      <strong>Test Coverage:</strong> This test suite validates the critical Android tablet virtual keyboard fix (Phase 1.10.5.1):
      <br>‚Ä¢ Bug: Android virtual keyboards don't fire keydown events for space/selection keys
      <br>‚Ä¢ Fix: Detect selection keys in input event and trigger selection manually
      <br>‚Ä¢ Impact: Makes app usable on Android tablets in both character and sentence modes
      <br><br><strong>Total Tests:</strong> 20 comprehensive tests
    </div>

    <div id="test-results"></div>
    <div id="summary" class="summary"></div>
  </div>

  <script>
    // ============================================
    // Test Utilities
    // ============================================

    let testResults = [];
    let passCount = 0;
    let failCount = 0;

    function runTest(name, testFn) {
      try {
        const result = testFn();
        if (result) {
          passCount++;
          testResults.push({ name, status: 'pass', message: result });
        } else {
          failCount++;
          testResults.push({ name, status: 'fail', message: 'Test returned false' });
        }
      } catch (error) {
        failCount++;
        testResults.push({ name, status: 'fail', message: error.message });
      }
    }

    function displayResults() {
      const container = document.getElementById('test-results');
      let html = '';

      let currentSection = '';
      testResults.forEach((result, index) => {
        const sectionMatch = result.name.match(/^Section (\d+):/);
        if (sectionMatch && sectionMatch[0] !== currentSection) {
          currentSection = sectionMatch[0];
          html += `<h2>${currentSection}</h2>`;
        }

        const statusClass = result.status === 'pass' ? 'pass' : 'fail';
        const icon = result.status === 'pass' ? '‚úÖ' : '‚ùå';
        html += `
          <div class="test-result ${statusClass}">
            ${icon} <strong>Test ${index + 1}</strong>: ${result.name}
            ${result.message ? `<br><small>${result.message}</small>` : ''}
          </div>
        `;
      });

      container.innerHTML = html;

      const total = passCount + failCount;
      const percentage = ((passCount / total) * 100).toFixed(1);
      const summaryElement = document.getElementById('summary');
      summaryElement.innerHTML = `
        Test Results: ${passCount}/${total} passing (${percentage}%)
        <br><small style="font-size: 14px; margin-top: 10px; display: block;">
        ‚úÖ ${passCount} passed | ‚ùå ${failCount} failed
        </small>
      `;
      summaryElement.className = failCount === 0 ? 'summary' : 'summary fail';
    }

    // ============================================
    // Mock Implementation
    // ============================================

    let currentCode = '';
    let currentCandidates = [];
    let codeBuffer = [];
    let outputBuffer = '';
    let inputMode = 'character'; // 'character' or 'sentence'

    // Mock dayiMap
    const dayiMap = new Map([
      ['4jp', [{ char: 'Êòì', freq: 100 }, { char: 'Áæ©', freq: 80 }]],
      ['ad', [{ char: 'Âú®', freq: 90 }, { char: 'ÂÜç', freq: 70 }]],
      ['a', [{ char: 'Â§ß', freq: 100 }]],
      ['f', [{ char: '‰Ω†', freq: 100 }]],
    ]);

    // Mock functions
    function handleInput(value, previousValue) {
      const code = value.trim().toLowerCase();
      currentCode = code;

      if (dayiMap.has(code)) {
        currentCandidates = dayiMap.get(code);
      } else {
        currentCandidates = [];
      }
    }

    function handleSelection(index) {
      if (!currentCode || currentCandidates.length === 0) return false;
      if (index < 0 || index >= currentCandidates.length) return false;

      const selected = currentCandidates[index];
      outputBuffer += selected.char;

      // Clear state
      currentCode = '';
      currentCandidates = [];

      return true;
    }

    function addToCodeBuffer(code, db) {
      if (!db.has(code)) return false;
      codeBuffer.push(code);
      return true;
    }

    function isSentenceMode() {
      return inputMode === 'sentence';
    }

    // ============================================
    // Android Virtual Keyboard Fix Logic (Extracted)
    // ============================================

    function simulateAndroidInput(inputValue) {
      const lastChar = inputValue.slice(-1);
      const selectionKeys = {
        ' ': 0,
        "'": 1,
        '[': 2,
        ']': 3,
        '-': 4,
        '\\': 5
      };

      if (lastChar in selectionKeys && inputValue.length > 1) {
        const codeWithoutKey = inputValue.slice(0, -1).trim().toLowerCase();
        const isInSentenceMode = isSentenceMode();

        if (isInSentenceMode) {
          // Sentence mode: Add code to buffer (space only)
          if (lastChar === ' ' && codeWithoutKey.length > 0) {
            const added = addToCodeBuffer(codeWithoutKey, dayiMap);
            return added ? 'buffer' : 'invalid';
          }
        } else {
          // Character mode: Trigger selection
          handleInput(codeWithoutKey, '');
          const selectionIndex = selectionKeys[lastChar];
          const success = handleSelection(selectionIndex);
          return success ? 'selected' : 'failed';
        }
      }

      // Normal input processing
      handleInput(inputValue, '');
      return 'normal';
    }

    // ============================================
    // Section 1: Detection Tests
    // ============================================

    runTest('Section 1: Test 1.1 - Detects space key in input', () => {
      const result = simulateAndroidInput('4jp ');
      return result === 'selected' ? 'Space key detected and selection triggered' : false;
    });

    runTest('Section 1: Test 1.2 - Detects apostrophe key in input', () => {
      const result = simulateAndroidInput("4jp'");
      return result === 'selected' ? 'Apostrophe key detected and selection triggered' : false;
    });

    runTest('Section 1: Test 1.3 - Detects left bracket key in input', () => {
      const result = simulateAndroidInput('4jp[');
      return result === 'selected' ? 'Left bracket key detected and selection triggered' : false;
    });

    runTest('Section 1: Test 1.4 - Detects right bracket key in input', () => {
      const result = simulateAndroidInput('4jp]');
      return result === 'selected' ? 'Right bracket key detected and selection triggered' : false;
    });

    runTest('Section 1: Test 1.5 - Detects dash key in input', () => {
      const result = simulateAndroidInput('4jp-');
      return result === 'selected' ? 'Dash key detected and selection triggered' : false;
    });

    runTest('Section 1: Test 1.6 - Detects backslash key in input', () => {
      const result = simulateAndroidInput('4jp\\');
      return result === 'selected' ? 'Backslash key detected and selection triggered' : false;
    });

    // ============================================
    // Section 2: Selection Tests (Character Mode)
    // ============================================

    runTest('Section 2: Test 2.1 - Space selects first candidate', () => {
      outputBuffer = '';
      currentCode = '';
      const result = simulateAndroidInput('4jp ');
      return (result === 'selected' && outputBuffer === 'Êòì') ? 'First candidate selected (Êòì)' : false;
    });

    runTest('Section 2: Test 2.2 - Apostrophe selects second candidate', () => {
      outputBuffer = '';
      currentCode = '';
      const result = simulateAndroidInput("4jp'");
      return (result === 'selected' && outputBuffer === 'Áæ©') ? 'Second candidate selected (Áæ©)' : false;
    });

    runTest('Section 2: Test 2.3 - Left bracket selects third candidate (if exists)', () => {
      // 4jp only has 2 candidates, so this should fail gracefully
      outputBuffer = '';
      currentCode = '';
      const result = simulateAndroidInput('4jp[');
      return (result === 'failed') ? 'Correctly handled out-of-range selection' : false;
    });

    runTest('Section 2: Test 2.4 - Clears input after selection', () => {
      outputBuffer = '';
      currentCode = '';
      simulateAndroidInput('4jp ');
      return (currentCode === '' && currentCandidates.length === 0) ? 'State cleared after selection' : false;
    });

    runTest('Section 2: Test 2.5 - Multiple selections work correctly', () => {
      outputBuffer = '';
      simulateAndroidInput('4jp '); // Êòì
      simulateAndroidInput('ad ');  // Âú®
      simulateAndroidInput('a ');   // Â§ß
      return (outputBuffer === 'ÊòìÂú®Â§ß') ? 'Multiple selections: ÊòìÂú®Â§ß' : false;
    });

    // ============================================
    // Section 3: Sentence Mode Tests
    // ============================================

    runTest('Section 3: Test 3.1 - Space adds code to buffer in sentence mode', () => {
      inputMode = 'sentence';
      codeBuffer = [];
      const result = simulateAndroidInput('4jp ');
      return (result === 'buffer' && codeBuffer.length === 1 && codeBuffer[0] === '4jp') ? 'Code added to buffer in sentence mode' : false;
    });

    runTest('Section 3: Test 3.2 - Multiple spaces build buffer in sentence mode', () => {
      inputMode = 'sentence';
      codeBuffer = [];
      simulateAndroidInput('4jp ');
      simulateAndroidInput('ad ');
      simulateAndroidInput('a ');
      return (codeBuffer.length === 3 && codeBuffer.join(',') === '4jp,ad,a') ? 'Buffer built correctly: [4jp, ad, a]' : false;
    });

    runTest('Section 3: Test 3.3 - Non-space keys ignored in sentence mode', () => {
      inputMode = 'sentence';
      codeBuffer = [];
      const result = simulateAndroidInput("4jp'");
      return (result !== 'buffer') ? 'Non-space keys ignored in sentence mode' : false;
    });

    runTest('Section 3: Test 3.4 - Invalid codes rejected in sentence mode', () => {
      inputMode = 'sentence';
      codeBuffer = [];
      const result = simulateAndroidInput('xyz ');
      return (result === 'invalid' && codeBuffer.length === 0) ? 'Invalid code rejected' : false;
    });

    // ============================================
    // Section 4: Edge Cases
    // ============================================

    runTest('Section 4: Test 4.1 - Single character input ignored', () => {
      outputBuffer = '';
      const result = simulateAndroidInput(' ');
      return (result === 'normal') ? 'Single space character ignored (length check)' : false;
    });

    runTest('Section 4: Test 4.2 - Empty input before selection key', () => {
      outputBuffer = '';
      const result = simulateAndroidInput(' ');
      return (outputBuffer === '') ? 'Empty input handled gracefully' : false;
    });

    runTest('Section 4: Test 4.3 - Invalid code with selection key', () => {
      inputMode = 'character';
      outputBuffer = '';
      const result = simulateAndroidInput('xyz ');
      return (result === 'failed' && outputBuffer === '') ? 'Invalid code with selection key handled' : false;
    });

    runTest('Section 4: Test 4.4 - Whitespace handling', () => {
      outputBuffer = '';
      simulateAndroidInput('  4jp  ');
      return (outputBuffer === 'Êòì') ? 'Whitespace trimmed correctly' : false;
    });

    // Reset mode
    inputMode = 'character';

    // ============================================
    // Display Results
    // ============================================

    displayResults();

    console.log('%c‚úÖ Android Virtual Keyboard Tests Complete', 'color: #28a745; font-weight: bold; font-size: 16px;');
    console.log(`%cResults: ${passCount}/${passCount + failCount} passing`, 'color: #0066cc; font-weight: bold;');
  </script>
</body>
</html>
