name: Run Tests

on:
  # Run on all pushes and pull requests
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'mvp1/**'
      - '.github/workflows/test.yml'

  pull_request:
    branches:
      - main

  # Allow manual trigger
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Display version information
        run: |
          echo "=== WebDaYi Version Information ==="
          if [ -f mvp1/version.json ]; then
            cat mvp1/version.json | grep -E '"version"|"build"|"commit"|"releaseName"'
          else
            echo "version.json not found"
          fi
          echo ""
          echo "Latest commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Run Laplace smoothing tests
        working-directory: mvp1
        run: |
          echo "Running Laplace smoothing tests..."
          node tests/node/test-laplace-smoothing.js

      - name: Run v11 UI initialization tests
        working-directory: mvp1
        run: |
          echo "Running v11 UI initialization tests..."
          node tests/node/test-v11-ui-init.js

      - name: Run v2.7 Hybrid algorithm tests
        working-directory: mvp1
        run: |
          echo "Running v2.7 Hybrid algorithm tests..."
          node tests/node/test-v27-hybrid.js

      - name: Run algorithm comparison tests
        working-directory: mvp1
        run: |
          echo "Running v2.5 vs v2.7 final comparison tests..."
          node tests/node/test-v25-vs-v27-final.js

      - name: Test Summary
        if: always()
        run: |
          echo "=== Test Summary ==="
          echo "All tests completed. Check individual steps for results."
          echo "Version: $(cat mvp1/version.json | grep '"version"' | cut -d'"' -f4)"
          echo "Build: $(cat mvp1/version.json | grep '"build"' | cut -d'"' -f4)"
